{% extends 'base.html' %}
{% load humanize %}

{% block title %}Propz - Find Your Next Property{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero">
    <div class="container">
        <h1>Find Your Perfect<br>Property Today</h1>
        <p>The all-in-one marketplace to list, find, and manage properties with total accountability.</p>

        <!-- Tabbed Search -->
        <div class="hero-search" style="max-width: 800px; margin: 2rem auto 0;">
            <form method="GET" action="{% url 'marketplace_list' %}" id="heroSearchForm">
                <div class="search-tabs">
                    <button type="button" class="search-tab active" data-listing="sale" onclick="setHomeTab(this)">
                        <i data-lucide="landmark" class="icon-sm"></i> Buy
                    </button>
                    <button type="button" class="search-tab" data-listing="rent" onclick="setHomeTab(this)">
                        <i data-lucide="key" class="icon-sm"></i> Rent
                    </button>
                    <button type="button" class="search-tab" data-listing="shortlet" onclick="setHomeTab(this)">
                        <i data-lucide="calendar" class="icon-sm"></i> Shortlet
                    </button>
                    <button type="button" class="search-tab" data-listing="land" onclick="setHomeTab(this)">
                        <i data-lucide="mountain" class="icon-sm"></i> Land
                    </button>
                </div>

                <input type="hidden" name="listing_type" id="heroListingType" value="sale">

                <!-- Search Bar -->
                <div class="search-bar-row">
                    <div class="search-input-wrap">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" name="q" placeholder="Search properties for sale using location"
                            class="search-main-input" id="heroSearchInput">
                    </div>
                    <button type="submit" class="btn btn-primary search-submit-btn">
                        <i data-lucide="search" class="icon-sm"></i> Search
                    </button>
                </div>

                <!-- Property Filters -->
                <div class="filter-bar" id="homePropertyFilters">
                    <div class="filter-item">
                        <label class="filter-label">Type</label>
                        <select name="property_type" class="filter-select">
                            <option value="">All Types</option>
                            <option value="house">House</option>
                            <option value="apartment">Apartment</option>
                            <option value="flat">Flat</option>
                            <option value="shop">Shop/Commercial</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="filter-divider"></div>
                    <div class="filter-item">
                        <label class="filter-label">Bedrooms</label>
                        <select name="bedrooms" class="filter-select">
                            <option value="">Any</option>
                            <option value="1">1 Bedroom</option>
                            <option value="2">2 Bedrooms</option>
                            <option value="3">3 Bedrooms</option>
                            <option value="4">4 Bedrooms</option>
                            <option value="5">5 Bedrooms</option>
                            <option value="6">6 Bedrooms</option>
                            <option value="7">7 Bedrooms</option>
                            <option value="8">8 Bedrooms</option>
                            <option value="9">9 Bedrooms</option>
                            <option value="10">10 Bedrooms</option>
                        </select>
                    </div>
                    <div class="filter-divider"></div>
                    <div class="filter-item">
                        <label class="filter-label">Min. Price</label>
                        <input type="number" name="min_price" placeholder="₦ Min" class="filter-input" min="0">
                    </div>
                    <div class="filter-divider"></div>
                    <div class="filter-item">
                        <label class="filter-label">Max. Price</label>
                        <input type="number" name="max_price" placeholder="₦ Max" class="filter-input" min="0">
                    </div>
                </div>

                <!-- Land Filters -->
                <div class="filter-bar land-filter-bar" id="homeLandFilters" style="display: none;">
                    <div class="land-converter-panel">
                        <h4 style="margin: 0 0 1rem; font-size: 0.95rem; color: var(--gray-600);"><i data-lucide="ruler"
                                class="icon-sm" style="vertical-align: middle;"></i> Land Size Converter</h4>
                        <div class="land-converter-row">
                            <div class="filter-item">
                                <label class="filter-label">From Unit</label>
                                <select class="filter-select" id="homeFromUnit">
                                    <option value="sqft">Square Feet (sq ft)</option>
                                    <option value="sqm">Square Metres (m²)</option>
                                    <option value="acres">Acres</option>
                                    <option value="hectares">Hectares</option>
                                    <option value="plots">Plots (60×120 ft)</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label class="filter-label">Value</label>
                                <input type="text" class="filter-input" id="homeFromValue"
                                    placeholder="e.g. 7200 or 60x120">
                            </div>
                            <div class="filter-item" style="align-self: flex-end;">
                                <button type="button" class="btn btn-outline btn-sm" id="homeConvertBtn"
                                    style="white-space: nowrap;">
                                    <i data-lucide="arrow-right-left" class="icon-xs"></i> Convert
                                </button>
                            </div>
                            <div class="filter-item">
                                <label class="filter-label">To Unit</label>
                                <select class="filter-select" id="homeToUnit">
                                    <option value="sqm">Square Metres (m²)</option>
                                    <option value="sqft">Square Feet (sq ft)</option>
                                    <option value="acres">Acres</option>
                                    <option value="hectares">Hectares</option>
                                    <option value="plots">Plots (60×120 ft)</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label class="filter-label">Result</label>
                                <div class="land-result" id="homeResult"> -</div>
                            </div>
                        </div>
                        <p class="land-converter-note" id="homeMessage" style="display: none;"></p>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Suggested Properties Section -->
{% if suggested_properties %}
<section style="padding: 4rem 0; background: var(--gray-50);">
    <div class="container">
        <div style="text-align: center; margin-bottom: 2.5rem;">
            <h2 style="margin-bottom: 0.5rem;">Featured Properties</h2>
            <p style="color: var(--gray-500); max-width: 600px; margin: 0 auto;">Explore some of the latest properties available on Propz.</p>
        </div>
        <div class="property-grid">
            {% for property in suggested_properties %}
            <a href="{% url 'marketplace_detail' pk=property.pk %}" class="property-card" style="text-decoration: none; color: inherit;">
                <div class="property-card-image" {% if property.photo %}style="background: none;"{% endif %}>
                    {% if property.photo %}
                    <img src="{{ property.photo.url }}" alt="{{ property.name }}" style="width:100%;height:100%;object-fit:cover;border-radius:12px 12px 0 0;">
                    {% else %}
                    <i data-lucide="house" class="icon-2xl" style="color: rgba(255,255,255,0.7);"></i>
                    {% endif %}
                    <div style="position: absolute; top: 12px; left: 12px; display: flex; gap: 6px;">
                        <span class="badge badge-success" style="background: var(--accent); color: white;">{{ property.get_listing_type_display }}</span>
                        <span class="badge badge-info">{{ property.get_property_type_display }}</span>
                    </div>
                </div>
                <div class="property-card-body">
                    <h4>{{ property.name }}</h4>
                    <p class="address"><i data-lucide="map-pin" class="icon-xs" style="vertical-align: middle;"></i> {{ property.address }} &middot; {{ property.get_state_display }}</p>
                    <div class="rent">&#8358;{{ property.rent_amount|floatformat:"0"|intcomma }}
                        {% if property.get_rent_period_display %}<span>/ {{ property.get_rent_period_display }}</span>{% endif %}
                    </div>
                    {% if property.bedrooms %}
                    <div style="margin-top: 0.5rem; color: var(--gray-500); font-size: 0.85rem;">
                        <i data-lucide="bed-double" class="icon-xs" style="vertical-align: middle;"></i> {{ property.bedrooms }} Bedroom{{ property.bedrooms|pluralize }}
                    </div>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
        <div style="text-align: center; margin-top: 2rem;">
            <a href="{% url 'marketplace_list' %}" class="btn btn-primary btn-lg">View All Properties</a>
        </div>
    </div>
</section>
{% endif %}

<!-- CTA Section -->
<section
    style="background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%); padding: 4rem 0; text-align: center;">
    <div class="container">
        <h2 style="color: white; margin-bottom: 1rem;">Ready to Get Started?</h2>
        <p
            style="color: var(--gray-300); margin-bottom: 2rem; max-width: 500px; margin-left: auto; margin-right: auto;">
            Whether you're a landlord looking to list properties or a tenant searching for a home, Propz has you
            covered.
        </p>
        <div class="hero-actions">
            <a href="{% url 'marketplace_list' %}" class="btn btn-primary btn-lg">Browse Properties</a>
            <a href="{% url 'login' %}" class="btn btn-secondary btn-lg">Sign In</a>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    function setHomeTab(btn) {
        document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');

        const listing = btn.dataset.listing;
        document.getElementById('heroListingType').value = listing;

        const searchInput = document.getElementById('heroSearchInput');
        const propertyFilters = document.getElementById('homePropertyFilters');
        const landFilters = document.getElementById('homeLandFilters');

        // Clear all filter values when switching tabs (match marketplace behavior)
        document.querySelectorAll('#homePropertyFilters .filter-select, #homePropertyFilters .filter-input').forEach(el => {
            el.value = '';
        });

        if (listing === 'land') {
            propertyFilters.style.display = 'none';
            landFilters.style.display = 'block';
            searchInput.placeholder = 'Search land for sale using location';
        } else {
            propertyFilters.style.display = 'flex';
            landFilters.style.display = 'none';
            const labels = { sale: 'properties for sale', rent: 'properties for rent', shortlet: 'shortlet properties' };
            searchInput.placeholder = 'Search ' + (labels[listing] || 'properties') + ' using location';
        }
    }

    // Land converter for home page
    document.addEventListener('DOMContentLoaded', function () {
        const convertBtn = document.getElementById('homeConvertBtn');
        const toSqFt = { sqft: 1, sqm: 10.7639, acres: 43560, hectares: 107639.104, plots: 7200 };
        const unitLabels = { sqft: 'sq ft', sqm: 'm²', acres: 'acres', hectares: 'hectares', plots: 'plots' };

        if (convertBtn) {
            convertBtn.addEventListener('click', function () {
                const fromUnit = document.getElementById('homeFromUnit').value;
                const toUnit = document.getElementById('homeToUnit').value;
                const rawValue = document.getElementById('homeFromValue').value.trim();
                const resultEl = document.getElementById('homeResult');
                const messageEl = document.getElementById('homeMessage');

                messageEl.style.display = 'none';
                resultEl.textContent = ' -';

                const dimMatch = rawValue.match(/^(\d+(?:\.\d+)?)\s*[xX×]\s*(\d+(?:\.\d+)?)$/);
                let value = dimMatch ? parseFloat(dimMatch[1]) * parseFloat(dimMatch[2]) : parseFloat(rawValue);

                if (isNaN(value) || value <= 0) {
                    messageEl.textContent = 'Please enter a valid number or dimensions (e.g. 7200 or 60x120).';
                    messageEl.style.display = 'block';
                    messageEl.style.color = 'var(--danger)';
                    return;
                }

                const sqft = value * toSqFt[fromUnit];
                const result = sqft / toSqFt[toUnit];
                resultEl.textContent = result.toLocaleString('en-NG', { maximumFractionDigits: 2 }) + ' ' + unitLabels[toUnit];
                messageEl.textContent = rawValue + ' ' + unitLabels[fromUnit] + ' = ' + resultEl.textContent;
                messageEl.style.display = 'block';
                messageEl.style.color = 'var(--accent)';
            });
        }
    });
</script>
{% endblock %}