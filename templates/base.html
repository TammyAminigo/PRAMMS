{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Propz - Find, rent, buy, and manage properties with full transparency.">
    <title>{% block title %}Propz{% endblock %}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=3">
    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-content">
            <!-- Left: Brand + Actions -->
            <div class="nav-left">
                <a href="{% url 'home' %}" class="navbar-brand">
                    <span class="logo-icon">P</span>
                    Propz
                </a>

                {% if user.is_authenticated and user.is_landlord %}
                <a href="{% url 'property_add' %}" class="btn btn-post-property">
                    <i data-lucide="plus" class="icon-sm"></i> Post Property
                </a>
                {% elif not user.is_authenticated %}
                <a href="{% url 'register' %}?next={% url 'property_add' %}" class="btn btn-post-property">
                    <i data-lucide="plus" class="icon-sm"></i> Post Property
                </a>
                {% endif %}
            </div>

            <!-- Center/Right: Discovery Dropdowns -->
            <div class="nav-right">
                <!-- Buy Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-dropdown-trigger">
                        Buy <i data-lucide="chevron-down" class="icon-xs"></i>
                    </button>
                    <div class="nav-dropdown-menu">
                        <a href="{% url 'marketplace_list' %}?listing_type=sale&property_type=flat"
                            class="dropdown-item">
                            <i data-lucide="building" class="icon-sm"></i> Flats & Apartments For Sale
                        </a>
                        <a href="{% url 'marketplace_list' %}?listing_type=sale&property_type=house"
                            class="dropdown-item">
                            <i data-lucide="house" class="icon-sm"></i> Houses For Sale
                        </a>
                        <a href="{% url 'marketplace_list' %}?listing_type=sale&property_type=land"
                            class="dropdown-item">
                            <i data-lucide="landmark" class="icon-sm"></i> Lands For Sale
                        </a>
                        <a href="{% url 'marketplace_list' %}?listing_type=sale&property_type=shop"
                            class="dropdown-item">
                            <i data-lucide="store" class="icon-sm"></i> Commercial Property For Sale
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="{% url 'marketplace_list' %}?listing_type=shortlet"
                            class="dropdown-item dropdown-highlight">
                            <i data-lucide="calendar-days" class="icon-sm"></i> Shortlet
                        </a>
                    </div>
                </div>

                <!-- Rent Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-dropdown-trigger">
                        Rent <i data-lucide="chevron-down" class="icon-xs"></i>
                    </button>
                    <div class="nav-dropdown-menu">
                        <a href="{% url 'marketplace_list' %}?listing_type=rent&property_type=flat"
                            class="dropdown-item">
                            <i data-lucide="building" class="icon-sm"></i> Flats & Apartments For Rent
                        </a>
                        <a href="{% url 'marketplace_list' %}?listing_type=rent&property_type=house"
                            class="dropdown-item">
                            <i data-lucide="house" class="icon-sm"></i> Houses For Rent
                        </a>
                        <a href="{% url 'marketplace_list' %}?listing_type=rent&property_type=shop"
                            class="dropdown-item">
                            <i data-lucide="briefcase" class="icon-sm"></i> Office Space For Rent
                        </a>
                        <a href="{% url 'marketplace_list' %}?listing_type=rent&property_type=land"
                            class="dropdown-item">
                            <i data-lucide="map" class="icon-sm"></i> Land Lease
                        </a>
                    </div>
                </div>

                {% if user.is_authenticated %}
                <!-- Authenticated Nav -->
                <a href="{% url 'dashboard' %}" class="nav-link">
                    <i data-lucide="layout-dashboard" class="icon-sm"></i> Dashboard
                </a>

                {% if user.is_landlord %}
                <a href="{% url 'property_list' %}" class="nav-link">
                    <i data-lucide="building-2" class="icon-sm"></i> Properties
                </a>
                <a href="{% url 'applications_list' %}" class="nav-link nav-link-badge">
                    <i data-lucide="clipboard-list" class="icon-sm"></i> Applications
                    {% if pending_applications_count %}
                    <span class="notification-badge">{{ pending_applications_count }}</span>
                    {% endif %}
                </a>
                {% endif %}

                {% if user.is_tenant %}
                <a href="{% url 'active_tenancies' %}" class="nav-link">
                    <i data-lucide="key-round" class="icon-sm"></i> My Tenancy
                </a>
                {% endif %}

                <a href="{% url 'maintenance_list' %}" class="nav-link nav-link-badge">
                    <i data-lucide="wrench" class="icon-sm"></i> Maintenance
                    {% if pending_requests %}
                    <span class="notification-badge">{{ pending_requests }}</span>
                    {% endif %}
                </a>

                <!-- User Avatar -->
                <a href="{% url 'my_account' %}" class="user-avatar-link" title="{{ user.get_full_name }}">
                    {% if user.profile_picture %}
                    <img src="{{ user.profile_picture.url }}" alt="{{ user.get_full_name }}" class="user-avatar-img">
                    {% else %}
                    <div class="user-avatar-placeholder">
                        {{ user.first_name.0 }}{{ user.last_name.0 }}
                    </div>
                    {% endif %}
                </a>

                <!-- Logout -->
                <form method="POST" action="{% url 'logout' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="nav-link logout-btn">
                        <i data-lucide="log-out" class="icon-sm"></i>
                    </button>
                </form>
                {% else %}
                <!-- Guest -->
                <a href="{% url 'login' %}" class="nav-link">Sign In</a>
                <a href="{% url 'register' %}" class="btn btn-signup">Sign Up</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
    <div class="messages-container">
        <div class="container">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" role="alert">
                <span>{{ message }}</span>
                <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-brand-col">
                    <div class="footer-brand">
                        <span class="logo-icon" style="display: inline-flex;">P</span>
                        <strong>Propz</strong>
                    </div>
                    <p class="footer-tagline">Find, rent, buy, and manage properties with full transparency.</p>
                </div>
                <div class="footer-links-col">
                    <h4>Discover</h4>
                    <a href="{% url 'marketplace_list' %}?listing_type=sale">Buy Property</a>
                    <a href="{% url 'marketplace_list' %}?listing_type=rent">Rent Property</a>
                    <a href="{% url 'marketplace_list' %}?listing_type=shortlet">Shortlet</a>
                    <a href="{% url 'marketplace_list' %}?listing_type=land">Land</a>
                </div>
                <div class="footer-links-col">
                    <h4>Account</h4>
                    <a href="{% url 'register' %}">Create Account</a>
                    <a href="{% url 'login' %}">Sign In</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Propz. Built for transparency in property management.</p>
            </div>
        </div>
    </footer>

    <!-- Auto-dismiss messages -->
    <script>
        setTimeout(() => {
            document.querySelectorAll('.alert').forEach(el => {
                el.style.transition = 'opacity 0.5s ease';
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 500);
            });
        }, 5000);
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>lucide.createIcons();</script>

    <script>
        // Active Navigation Highlighting
        document.addEventListener('DOMContentLoaded', () => {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');

            navLinks.forEach(link => {
                // Use pathname to ignore query parameters (e.g. ?listing_type=sale)
                if (link.pathname === window.location.pathname && link.getAttribute('href') !== '#') {
                    link.classList.add('active');
                }
            });

            // Apply active styling to match hover state
            const style = document.createElement('style');
            style.innerHTML = `
                .nav-link.active {
                    color: var(--white) !important;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: var(--radius-sm);
                }
            `;
            document.head.appendChild(style);
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>